{% extends "console/base.html" %}

{% block title %}Fine-tuning · Ollama Console{% endblock %}

{% block content %}
  <section class="pagehead">
    <h1 class="pagehead__title">Fine-tuning</h1>
    <p class="pagehead__subtitle">Fine-tune local Ollama models with your own datasets.</p>
  </section>

  {% if ollama_error %}
    <div class="alert alert--error">
      <div class="alert__title">Ollama is not reachable</div>
      <div class="alert__body">{{ ollama_error }}</div>
    </div>
  {% endif %}

  <div class="split">
    <aside class="card sidebar">
      <div class="sidebar__head">
        <h2>Create New Job</h2>
      </div>
      
      <form id="finetune-form" class="form" enctype="multipart/form-data">
        {% csrf_token %}
        
        <div class="form__group">
          <label class="form__label" for="job-name">Job Name</label>
          <input 
            class="input" 
            id="job-name" 
            name="name" 
            placeholder="e.g., My Fine-tuned Model"
            value="Fine-tuned Model"
          />
        </div>
        
        <div class="form__group">
          <label class="form__label" for="base-model">Base Model</label>
          {% if available_models %}
            <select class="select" id="base-model" name="base_model" required>
              <option value="">Select a model</option>
              {% for model in available_models %}
                <option value="{{ model }}">{{ model }}</option>
              {% endfor %}
            </select>
          {% else %}
            <input 
              class="input" 
              id="base-model" 
              name="base_model" 
              placeholder="e.g., llama3.2:latest"
              required
            />
          {% endif %}
        </div>
        
        <div class="form__group">
          <label class="form__label" for="dataset-file">Dataset File</label>
          <input 
            class="input" 
            type="file" 
            id="dataset-file" 
            name="dataset_file" 
            accept=".jsonl,.csv,.txt"
            required
          />
          <div class="form__help">
            Supported formats: JSONL (preferred) or CSV with 'role' and 'content' columns
          </div>
        </div>
        
        <div class="form__group">
          <label class="form__label" for="epochs">Epochs</label>
          <input 
            class="input" 
            type="number" 
            id="epochs" 
            name="epochs" 
            min="1" 
            max="100" 
            value="3"
          />
        </div>
        
        <div class="form__group">
          <label class="form__label" for="learning-rate">Learning Rate</label>
          <input 
            class="input" 
            type="number" 
            id="learning-rate" 
            name="learning_rate" 
            step="0.0001" 
            min="0.00001" 
            max="0.01" 
            value="0.0001"
          />
        </div>
        
        <div class="form__group">
          <label class="form__label" for="batch-size">Batch Size</label>
          <input 
            class="input" 
            type="number" 
            id="batch-size" 
            name="batch_size" 
            min="1" 
            max="32" 
            value="4"
          />
        </div>
        
        <div class="form__actions">
          <button class="btn" type="submit">Start Fine-tuning</button>
        </div>
        
        <div id="create-status" class="form__status"></div>
      </form>
    </aside>
    
    <section class="card">
      <div class="card__head">
        <h2>Fine-tuning Jobs</h2>
        <button 
          class="btn btn--secondary" 
          id="refresh-jobs"
          type="button"
        >
          Refresh
        </button>
      </div>
      
      <div id="jobs-container">
        {% include "console/_finetune_jobs.html" %}
      </div>
    </section>
  </div>
  
  <!-- Job Detail Modal -->
  <div id="job-detail-modal" class="modal" style="display: none;">
    <div class="modal__content">
      <div class="modal__header">
        <h3 id="modal-title">Job Details</h3>
        <button class="modal__close" onclick="closeModal()">×</button>
      </div>
      <div class="modal__body" id="modal-body">
        Loading...
      </div>
    </div>
  </div>
{% endblock %}

{% block customejs %}
<script>
  // Modal functions
  function openModal(jobId) {
    fetch(`/finetune/job/${jobId}/`)
      .then(response => response.json())
      .then(data => {
        document.getElementById('modal-title').textContent = `Job: ${data.name}`;
        
        let html = `
          <div class="job-detail">
            <div class="detail-row">
              <strong>Status:</strong> <span class="status-badge status-${data.status}">${data.status}</span>
            </div>
            <div class="detail-row">
              <strong>Base Model:</strong> ${data.base_model}
            </div>
            ${data.fine_tuned_model ? `<div class="detail-row"><strong>Fine-tuned Model:</strong> ${data.fine_tuned_model}</div>` : ''}
            <div class="detail-row">
              <strong>Progress:</strong> ${data.progress.toFixed(1)}%
            </div>
            <div class="detail-row">
              <strong>Epochs:</strong> ${data.current_epoch} / ${data.epochs}
            </div>
            ${data.loss ? `<div class="detail-row"><strong>Loss:</strong> ${data.loss.toFixed(4)}</div>` : ''}
            <div class="detail-row">
              <strong>Duration:</strong> ${formatDuration(data.duration)}
            </div>
            <div class="detail-row">
              <strong>Created:</strong> ${new Date(data.created_at).toLocaleString()}
            </div>
            ${data.started_at ? `<div class="detail-row"><strong>Started:</strong> ${new Date(data.started_at).toLocaleString()}</div>` : ''}
            ${data.completed_at ? `<div class="detail-row"><strong>Completed:</strong> ${new Date(data.completed_at).toLocaleString()}</div>` : ''}
            ${data.error_message ? `<div class="detail-row"><strong>Error:</strong> <pre class="error-message">${data.error_message}</pre></div>` : ''}
          </div>
        `;
        
        document.getElementById('modal-body').innerHTML = html;
        document.getElementById('job-detail-modal').style.display = 'block';
      })
      .catch(error => {
        document.getElementById('modal-body').innerHTML = `<div class="alert alert--error">Error loading job details: ${error.message}</div>`;
      });
  }
  
  function closeModal() {
    document.getElementById('job-detail-modal').style.display = 'none';
  }
  
  function formatDuration(seconds) {
    if (!seconds) return '0s';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    const parts = [];
    if (hours > 0) parts.push(`${hours}h`);
    if (minutes > 0) parts.push(`${minutes}m`);
    if (secs > 0 || parts.length === 0) parts.push(`${secs}s`);
    
    return parts.join(' ');
  }
  
  // Close modal when clicking outside
  window.addEventListener('click', (event) => {
    const modal = document.getElementById('job-detail-modal');
    if (event.target === modal) {
      closeModal();
    }
  });
  
  // Form submission
  document.getElementById('finetune-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const formData = new FormData(form);
    const statusEl = document.getElementById('create-status');
    
    statusEl.textContent = 'Creating job...';
    statusEl.className = 'form__status';
    
    try {
      const response = await fetch('/finetune/create/', {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
        },
      });
      
      const data = await response.json();
      
      if (response.ok) {
        statusEl.textContent = data.message;
        statusEl.className = 'form__status form__status--success';
        form.reset();
        // Refresh jobs list
        refreshJobs();
        // Start monitoring the new job
        if (data.job_id) {
          monitorJobProgress(data.job_id);
        }
      } else {
        statusEl.textContent = `Error: ${data.error || 'Unknown error'}`;
        statusEl.className = 'form__status form__status--error';
        if (data.details) {
          console.error('Validation errors:', data.details);
        }
      }
    } catch (error) {
      statusEl.textContent = `Request failed: ${error.message}`;
      statusEl.className = 'form__status form__status--error';
    }
  });
  
  // Refresh jobs list
  document.getElementById('refresh-jobs').addEventListener('click', refreshJobs);
  
  function refreshJobs() {
    fetch('/finetune/')
      .then(response => response.text())
      .then(html => {
        // Extract just the jobs table from the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const jobsTable = doc.querySelector('#jobs-container');
        if (jobsTable) {
          document.getElementById('jobs-container').innerHTML = jobsTable.innerHTML;
          // Re-attach event listeners to new elements
          attachJobEventListeners();
        }
      })
      .catch(error => {
        console.error('Error refreshing jobs:', error);
      });
  }
  
  function attachJobEventListeners() {
    // Attach click handlers to job rows
    document.querySelectorAll('.job-row').forEach(row => {
      row.addEventListener('click', () => {
        const jobId = row.dataset.jobId;
        if (jobId) {
          openModal(jobId);
        }
      });
    });
    
    // Attach click handlers to cancel buttons
    document.querySelectorAll('.job-cancel').forEach(button => {
      button.addEventListener('click', async (e) => {
        e.stopPropagation();
        const jobId = button.dataset.jobId;
        if (!jobId) return;
        
        if (!confirm('Are you sure you want to cancel this job?')) return;
        
        try {
          const response = await fetch('/finetune/cancel/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': getCookie('csrftoken'),
            },
            body: `job_id=${jobId}`,
          });
          
          const data = await response.json();
          if (response.ok) {
            alert(data.message);
            refreshJobs();
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          alert(`Request failed: ${error.message}`);
        }
      });
    });
    
    // Attach click handlers to delete buttons
    document.querySelectorAll('.job-delete').forEach(button => {
      button.addEventListener('click', async (e) => {
        e.stopPropagation();
        const jobId = button.dataset.jobId;
        if (!jobId) return;
        
        if (!confirm('Are you sure you want to delete this job? This will also delete the fine-tuned model if it exists.')) return;
        
        try {
          const response = await fetch('/finetune/delete/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': getCookie('csrftoken'),
            },
            body: `job_id=${jobId}`,
          });
          
          const data = await response.json();
          if (response.ok) {
            alert(data.message);
            refreshJobs();
          } else {
            alert(`Error: ${data.error}`);
          }
        } catch (error) {
          alert(`Request failed: ${error.message}`);
        }
      });
    });
  }
  
  // Monitor job progress
  function monitorJobProgress(jobId) {
    const eventSource = new EventSource(`/finetune/progress/${jobId}/`);
    
    eventSource.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        
        // Update the job row if it exists
        const jobRow = document.querySelector(`.job-row[data-job-id="${jobId}"]`);
        if (jobRow) {
          const progressBar = jobRow.querySelector('.progress-bar');
          const progressText = jobRow.querySelector('.progress-text');
          const statusBadge = jobRow.querySelector('.status-badge');
          
          if (progressBar && progressText) {
            progressBar.style.width = `${data.progress}%`;
            progressText.textContent = `${data.progress.toFixed(1)}%`;
          }
          
          if (statusBadge) {
            statusBadge.textContent = data.status;
            statusBadge.className = `status-badge status-${data.status}`;
          }
        }
        
        // Close connection if job is done
        if (data.done) {
          eventSource.close();
          // Refresh the jobs list to get final state
          setTimeout(() => refreshJobs(), 1000);
        }
      } catch (error) {
        console.error('Error parsing progress update:', error);
      }
    };
    
    eventSource.onerror = (error) => {
      console.error('EventSource failed:', error);
      eventSource.close();
    };
  }
  
  // Initial attachment of event listeners
  document.addEventListener('DOMContentLoaded', () => {
    attachJobEventListeners();
    
    // Monitor any running jobs on page load
    document.querySelectorAll('.job-row[data-status="running"]').forEach(row => {
      const jobId = row.dataset.jobId;
      if (jobId) {
        monitorJobProgress(jobId);
      }
    });
  });
</script>
{% endblock %}
